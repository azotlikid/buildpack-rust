#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir> <env-dir>

set -o errexit
set -o pipefail

BUILD_DIR=${1:-}
CACHE_DIR=${2:-}
ENV_DIR=${3:-}
BP_DIR=$(cd "$(dirname ${0:-})"; cd ..; pwd)

echo "BUILD_DIR:$BUILD_DIR"
echo "CACHE_DIR:$CACHE_DIR"
echo "ENV_DIR:$ENV_DIR"
echo "BP_DIR:$BP_DIR"

VERSION=nightly

RUSTUP_HOME=$CACHE_DIR/rustup-$VERSION
CARGO_HOME=$CACHE_DIR/cargo

if ! [ -d $RUSTUP_HOME ]; then
    mkdir -p $RUSTUP_HOME
fi

if ! [ -d $CARGO_HOME ]; then
    mkdir -p $CARGO_HOME
fi

echo "------>"
echo `ls -a $CACHE_DIR`


if [ -d "$HOME/.cargo/bin" ]; then
    echo "-----> Checking for new releases of Rust $VERSION channel"
    # It's possible that $VERSION has changed, or the `stable` channel has updated.
    rustup self update
    rustup update "$VERSION"
    rustup default "$VERSION"
else

    echo "-----> Downloading rustup"
    curl https://sh.rustup.rs -sSf > rustup.sh
    chmod u+x rustup.sh
    echo "-----> Using rustup to install Rust channel $VERSION"
    ./rustup.sh -y --default-toolchain "$VERSION"
    rm rustup.sh
    echo "@@@@@@@@@@@@@@@@@"
    echo `ls -a $HOME`
    . $HOME/.cargo/env
fi
if [ ! -x "$HOME/.cargo/bin/rustc" ]; then
    echo "failed: Cannot find Rust binaries at $CARGO_HOME"
    exit 1
fi

export CARGO_TARGET_DIR="$CACHE_DIR/target"

echo "-----> Building application using Cargo"
cd "$BUILD_DIR/$BUILD_PATH"
rm -rf target/
cargo build --release
mkdir -p target/release
find "$CARGO_TARGET_DIR/release" -maxdepth 1 -type f -executable -exec cp -a -t target/release {} \;

